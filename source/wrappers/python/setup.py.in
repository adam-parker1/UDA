#!/usr/bin/env python

import os
import sys
import sysconfig
from distutils.core import setup, Extension
from Cython.Build import cythonize
import numpy

extra_link_args = []
extra_compile_args = []

root = os.environ.get('UDA_DIR', '@CMAKE_INSTALL_PREFIX@')

print('Detected platform: ' + sys.platform)
print('Detected system: ' + sysconfig.get_platform())

stalib_ext = ''
dynlib_ext = ''
if sys.platform.lower() == 'linux':
    stalib_ext = 'a'
    dynlib_ext = 'so'
elif sys.platform.lower() == 'darwin':
    stalib_ext = 'a'
    dynlib_ext = 'dylib'
    # On Mac OS we have to force setting of rpath
    extra_link_args.append('-Wl,-rpath,%s/lib' % root)
elif sys.platform.lower() == 'win32':
    if sysconfig.get_platform().lower() == 'mingw':
        stalib_ext = 'a'
        dynlib_ext = 'so'
    else:
        stalib_ext = 'lib'
        dynlib_ext = 'dll'
elif sys.platform.lower() == 'msys':
    stalib_ext = 'a'
    dynlib_ext = 'so'
else:
    sys.exit('system not recognized!')
	
build_fat = os.environ.get('UDA_FAT_PYTHON', False)
if build_fat:
    uda_lib = 'libfat@PROJECT_NAME@_client.' + stalib_ext
    extra_libs = ['xml2', 'pq']
    extra_macros = [('FATCLIENT', None)]
else:
    uda_lib = 'lib@PROJECT_NAME@_client.' + stalib_ext
    extra_libs = []
    extra_macros = []

ext = Extension(
    'cpyuda',
    ['pyuda/cpyuda/cpyuda.pyx'],
    include_dirs=[
        root + '/include/uda',
        numpy.get_include(),
    ],
    libraries=['ssl', 'crypto'] + extra_libs,
    library_dirs=[
        '@OPENSSL_LIB_DIR@',
    ],
    runtime_library_dirs=[
        '@OPENSSL_LIB_DIR@',
    ],
    extra_objects=[root + '/lib/' + uda_lib],
    extra_link_args=extra_link_args,
    extra_compile_args=extra_compile_args,
    language='c++',
)

setup(
    name='@PROJECT_NAME@',
    version='@PROJECT_VERSION@',
    description='Unified Data Access (UDA)',
    author='Jonathan Hollocombe',
    author_email='jonathan.hollocombe@ukaea.uk',
    url='https://git.iter.org/projects/IMAS/repos/uda/browse',
    packages=['pyuda'],
    ext_modules=cythonize([ext]),
    install_requires=['numpy>=1.7'],
)
